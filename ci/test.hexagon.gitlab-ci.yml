# Hexagon DSP cross-compilation tests
# This file is part of Eigen, a lightweight C++ template library
# for linear algebra.
#
# Copyright (C) 2023, The Eigen Authors
#
# This Source Code Form is subject to the terms of the Mozilla
# Public License v. 2.0. If a copy of the MPL was not distributed
# with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Base configuration for Hexagon DSP testing using QEMU emulation
.test:linux:hexagon:
  extends: .common:linux:cross
  stage: test
  image: ubuntu:20.04
  variables:
    EIGEN_CI_TARGET_ARCH: hexagon
    EIGEN_CI_CTEST_LABEL: "Hexagon"
    EIGEN_CI_HEXAGON_ARCH: v68
    EIGEN_CI_HEXAGON_TOOLCHAIN_VERSION: "20.1.4"
    # Test-specific configuration
    EIGEN_CI_TEST_TIMEOUT: 300
    EIGEN_CI_HEXAGON_EMULATION: "true"
  before_script:
    - . ci/scripts/common.linux.before_script.sh
    - . ci/scripts/setup.hexagon.sh
  script:
    - . ci/scripts/test.hexagon.sh
  artifacts:
    when: always
    name: "$CI_JOB_NAME_SLUG-$CI_COMMIT_REF_SLUG"
    paths:
      - ${EIGEN_CI_BUILDDIR}/
      - hexagon_perf.json
    reports:
      junit: ${EIGEN_CI_BUILDDIR}/Testing/*/Test.xml
    expire_in: 5 days
  tags:
    - linux
    - eigen-runner
  rules:
    # Run on scheduled builds (nightly)
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_NAMESPACE == "libeigen"
    # Run on manual web triggers
    - if: $CI_PIPELINE_SOURCE == "web" && $CI_PROJECT_NAMESPACE == "libeigen"
    # Run on merge requests with hexagon-tests label
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_NAMESPACE == "libeigen" && $CI_MERGE_REQUEST_LABELS =~ "/hexagon-tests/"
  cache:
    key: "hexagon-test-$CI_COMMIT_REF_SLUG-$EIGEN_CI_HEXAGON_ARCH"
    paths:
      - .cache/ccache/
      - .cache/hexagon-toolchain/
    policy: pull

######## Hexagon v68 Tests ######################################################

# Basic Hexagon v68 functionality tests
test:linux:hexagon:v68:default:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v68
    EIGEN_CI_CTEST_REGEX: "basicstuff|linearalgebra|array_cwise"
  dependencies:
    - build:linux:hexagon:v68:default
  needs:
    - build:linux:hexagon:v68:default

# Hexagon v68 with HVX vector tests
test:linux:hexagon:v68:hvx:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v68
    EIGEN_CI_CTEST_REGEX: "hvx|packet|simd"
    EIGEN_CI_TEST_TIMEOUT: 600  # Long timeout for HVX tests
  dependencies:
    - build:linux:hexagon:v68:hvx
  needs:
    - build:linux:hexagon:v68:hvx

# Hexagon v68 comprehensive test suite
test:linux:hexagon:v68:comprehensive:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v68
    EIGEN_CI_CTEST_LABEL: "Official"
    EIGEN_CI_TEST_TIMEOUT: 900  # Extended timeout for comprehensive tests
  dependencies:
    - build:linux:hexagon:v68:default
  needs:
    - build:linux:hexagon:v68:default
  rules:
    # Only run comprehensive tests on schedule or with special label
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_NAMESPACE == "libeigen"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_NAMESPACE == "libeigen" && $CI_MERGE_REQUEST_LABELS =~ "/hexagon-comprehensive/"

######## Hexagon v73 Tests ######################################################

# Hexagon v73 basic functionality tests
test:linux:hexagon:v73:default:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v73
    EIGEN_CI_CTEST_REGEX: "basicstuff|linearalgebra"
  dependencies:
    - build:linux:hexagon:v73:default
  needs:
    - build:linux:hexagon:v73:default

# Hexagon v73 with HVX vector tests
test:linux:hexagon:v73:hvx:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v73
    EIGEN_CI_CTEST_REGEX: "hvx|packet|simd"
    EIGEN_CI_TEST_TIMEOUT: 600
  dependencies:
    - build:linux:hexagon:v73:hvx
  needs:
    - build:linux:hexagon:v73:hvx

######## Performance Tests ######################################################

# Hexagon performance benchmarking
test:linux:hexagon:v68:performance:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v68
    EIGEN_CI_CTEST_REGEX: "bench"
    EIGEN_CI_TEST_TIMEOUT: 1200  # Long timeout for benchmarks
  dependencies:
    - build:linux:hexagon:v68:optimized
  needs:
    - build:linux:hexagon:v68:optimized
  artifacts:
    when: always
    paths:
      - ${EIGEN_CI_BUILDDIR}/
      - hexagon_perf.json
      - benchmark_results/
    reports:
      performance: hexagon_perf.json
    expire_in: 30 days  # Keep performance data longer
  rules:
    # Run performance tests on schedule and with performance label
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_NAMESPACE == "libeigen"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_NAMESPACE == "libeigen" && $CI_MERGE_REQUEST_LABELS =~ "/hexagon-performance/"

######## Quick Validation Tests #############################################

# Quick smoke test for merge requests
test:linux:hexagon:v68:smoke:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v68
    EIGEN_CI_CTEST_REGEX: "basicstuff"
    EIGEN_CI_TEST_TIMEOUT: 120  # Quick timeout
  dependencies:
    - build:linux:hexagon:v68:minimal
  needs:
    - build:linux:hexagon:v68:minimal
  rules:
    # Run on all merge requests for basic validation
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_NAMESPACE == "libeigen"

######## Debug Tests ########################################################

# Debug build testing (for troubleshooting)
test:linux:hexagon:v68:debug:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v68
    EIGEN_CI_CTEST_REGEX: "basicstuff|array_cwise"
    EIGEN_CI_TEST_TIMEOUT: 600
    EIGEN_CI_DEBUG_MODE: "true"
  dependencies:
    - build:linux:hexagon:v68:debug
  needs:
    - build:linux:hexagon:v68:debug
  rules:
    # Only run debug tests when specifically requested
    - if: $CI_PIPELINE_SOURCE == "web" && $CI_PROJECT_NAMESPACE == "libeigen"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_NAMESPACE == "libeigen" && $CI_MERGE_REQUEST_LABELS =~ "/hexagon-debug/"
  allow_failure: true  # Debug tests can be flaky 