# Hexagon DSP cross-compilation tests
# This file is part of Eigen, a lightweight C++ template library
# for linear algebra.
#
# Copyright (C) 2023, The Eigen Authors
#
# This Source Code Form is subject to the terms of the Mozilla
# Public License v. 2.0. If a copy of the MPL was not distributed
# with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Enhanced Hexagon Testing CI Configuration
# Updated for v73 architecture with default and hvx test categories

# Base test configuration for Hexagon
.test:linux:hexagon:
  stage: test
  image: $CI_REGISTRY_IMAGE/eigen-ci:hexagon-latest
  variables:
    EIGEN_CI_TARGET_ARCH: hexagon
    EIGEN_CI_TEST_TIMEOUT: "300"
    EIGEN_CI_MAX_PARALLEL_TESTS: "4"
    # Test only the specific targets that were built
    EIGEN_CI_TEST_TARGETS: "packetmath_1 packetmath_2 packetmath_3 basicstuff_1 vectorization_logic_1"
    # Enhanced testing configuration
    EIGEN_CI_ENABLE_VALIDATION: "true"
    EIGEN_CI_ENABLE_MONITORING: "true" 
  before_script:
    - ./ci/test-hexagon-setup.sh
  script:
    - cd ${EIGEN_CI_BUILDDIR:-.build}
    # Run tests only for the specific built targets
    - for target in ${EIGEN_CI_TEST_TARGETS}; do echo "Testing target: $target"; ctest --output-on-failure --timeout ${EIGEN_CI_TEST_TIMEOUT} -j${EIGEN_CI_MAX_PARALLEL_TESTS} -R "^${target}$" || true; done
  after_script:
    - mkdir -p artifacts/hexagon-tests
    - cp -r ${EIGEN_CI_BUILDDIR:-.build}/Testing artifacts/hexagon-tests/ || true
    - cp -r ${EIGEN_CI_BUILDDIR:-.build}/*.log artifacts/hexagon-tests/ || true
  artifacts:
    when: always
    name: "hexagon-test-results-${CI_JOB_NAME}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - artifacts/hexagon-tests/
      - ${EIGEN_CI_BUILDDIR:-.build}/Testing/
    reports:
      junit: 
        - ${EIGEN_CI_BUILDDIR:-.build}/Testing/**/Test.xml
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "hexagon_toolchain"
    - if: $CI_COMMIT_BRANCH == "hexagon_toolchain-mirror"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

######## Hexagon v73 Tests ############################################

# v73 Default Tests
test:linux:hexagon:v73:default:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v73
    EIGEN_CI_BUILDDIR: .build-hexagon-v73-default
  dependencies:
    - build:linux:hexagon:v73:default
  needs:
    - job: build:linux:hexagon:v73:default
      artifacts: true

# v73 HVX Tests
test:linux:hexagon:v73:hvx:
  extends: .test:linux:hexagon
  variables:
    EIGEN_CI_HEXAGON_ARCH: v73
    EIGEN_CI_BUILDDIR: .build-hexagon-v73-hvx
    EIGEN_CI_TEST_TIMEOUT: "600"  # Longer timeout for HVX tests
    EIGEN_CI_ENABLE_HVX_VALIDATION: "true"
  dependencies:
    - build:linux:hexagon:v73:hvx
  needs:
    - job: build:linux:hexagon:v73:hvx
      artifacts: true
